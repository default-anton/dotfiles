#!/usr/bin/env bash

set -eo pipefail

# Source shared library
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/mlx-audio/constants.sh"
source "${SCRIPT_DIR}/mlx-audio/lib.sh"

MODEL="${DEFAULT_STT_MODEL}"
LANGUAGE=""
OUTPUT=""
AUDIO_FILE=""

usage() {
    local exit_code="${1:-1}"
    cat <<EOF
Usage: $0 [AUDIO_FILE] [--model MODEL] [--language LANG] [--output FILE]

Transcribe audio to text using mlx-audio server.

Arguments:
  AUDIO_FILE      Audio file to transcribe (optional, reads from stdin if not provided)
  --model MODEL   STT model (default: ${DEFAULT_STT_MODEL})
  --language LANG Language hint, e.g., 'en', 'es' (optional)
  --output FILE   Write transcription to file instead of stdout
  -h, --help      Show this help

Supported formats: mp3, wav, m4a, flac, ogg (any format ffmpeg can read)

Examples:
  $0 recording.mp3
  $0 meeting.m4a --language en --output notes.txt
  ffmpeg -i video.mp4 -f wav - | $0 --language es
EOF
    exit "$exit_code"
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        --model)
            MODEL="$2"
            shift 2
            ;;
        --language)
            LANGUAGE="$2"
            shift 2
            ;;
        --output)
            OUTPUT="$2"
            shift 2
            ;;
        -h|--help)
            usage 0
            ;;
        -*)
            echo "Unknown option: $1" >&2
            usage 1
            ;;
        *)
            if [[ -z "$AUDIO_FILE" ]]; then
                AUDIO_FILE="$1"
                shift
            else
                echo "Unknown argument: $1" >&2
                usage 1
            fi
            ;;
    esac
done

# Ensure server is running (suppress output)
mlx_audio_server_ensure 2>/dev/null || exit 1

# Prepare temp file for audio processing
TEMP_AUDIO=$(mktemp /tmp/stt_XXXXXX.audio)
trap 'mlx_audio_cleanup "$TEMP_AUDIO"' EXIT

# Get audio data
if [[ -n "$AUDIO_FILE" ]]; then
    if [[ ! -f "$AUDIO_FILE" ]]; then
        echo "Error: Audio file '$AUDIO_FILE' not found." >&2
        exit 1
    fi
    cp "$AUDIO_FILE" "$TEMP_AUDIO"
else
    # Read from stdin
    cat > "$TEMP_AUDIO"
fi

# Convert Ogg/Opus (Telegram voice) to MP3 for mlx-audio compatibility
if file "$TEMP_AUDIO" | grep -q "Ogg data"; then
    TEMP_MP3=$(mktemp /tmp/stt_XXXXXX.mp3)
    ffmpeg -i "$TEMP_AUDIO" -ar 16000 -ac 1 -y "$TEMP_MP3" 2>/dev/null || exit 1
    mv "$TEMP_MP3" "$TEMP_AUDIO"
fi

# Build curl command
CURL_ARGS=(
    -s -f
    -X POST "http://localhost:${MLX_AUDIO_PORT}/v1/audio/transcriptions"
    -F "file=@${TEMP_AUDIO}"
    -F "model=${MODEL}"
)

[[ -n "$LANGUAGE" ]] && CURL_ARGS+=(-F "language=${LANGUAGE}")

# Send request and extract text from NDJSON response
# The server returns newline-delimited JSON, we want the final text
TRANSCRIPT=$(curl "${CURL_ARGS[@]}" | jq -r 'select(.text) | .text' | tr -d '\n' | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//')

if [[ -z "$TRANSCRIPT" ]]; then
    echo "Error: Failed to transcribe audio." >&2
    exit 1
fi

# Output result
if [[ -n "$OUTPUT" ]]; then
    echo "$TRANSCRIPT" > "$OUTPUT"
else
    echo "$TRANSCRIPT"
fi
