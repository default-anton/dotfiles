#!/usr/bin/env bash

set -eo pipefail

# Source shared library
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/mlx-audio/constants.sh"
source "${SCRIPT_DIR}/mlx-audio/lib.sh"

MODEL="${DEFAULT_TTS_MODEL}"
VOICE="${DEFAULT_TTS_VOICE}"
SPEED="${DEFAULT_TTS_SPEED}"
OUTPUT="speech.mp3"
INPUT_FILE=""
TEXT=""

usage() {
    local exit_code="${1:-1}"
    cat <<EOF
Usage: $0 [TEXT] [--input FILE] [--output FILE] [--speed SPEED] [--voice VOICE] [--model MODEL]

Arguments:
  TEXT            Text to speak (optional if --input or stdin is used)
  --input FILE    Read text from FILE
  --output FILE   Output mono MP3 file (default: speech.mp3)
  --speed SPEED   Speech speed (default: ${DEFAULT_TTS_SPEED})
  --voice VOICE   Voice to use (default: ${DEFAULT_TTS_VOICE})
  --model MODEL   TTS model (default: ${DEFAULT_TTS_MODEL})
  -h, --help      Show this help

Input text must be plain text with no formatting (no HTML, no Markdown).
Minimal formatting like bullet lists is fine. Output is always a mono MP3 file.
EOF
    exit "$exit_code"
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        --input)
            INPUT_FILE="$2"
            shift 2
            ;;
        --output)
            OUTPUT="$2"
            shift 2
            ;;
        --speed)
            SPEED="$2"
            shift 2
            ;;
        --voice)
            VOICE="$2"
            shift 2
            ;;
        --model)
            MODEL="$2"
            shift 2
            ;;
        -h|--help)
            usage 0
            ;;
        *)
            if [[ -z "$TEXT" ]]; then
                TEXT="$1"
                shift
            else
                echo "Unknown argument: $1" >&2
                usage 1
            fi
            ;;
    esac
done

# Resolve input text (Precedence: --input > positional > stdin)
if [[ -n "$INPUT_FILE" ]]; then
    if [[ ! -f "$INPUT_FILE" ]]; then
        echo "Error: Input file '$INPUT_FILE' not found." >&2
        exit 1
    fi
    TEXT=$(cat "$INPUT_FILE")
elif [[ -z "$TEXT" ]]; then
    if [[ ! -t 0 ]]; then
        TEXT=$(cat)
    fi
fi

if [[ -z "$TEXT" ]]; then
    echo "Error: No text provided." >&2
    usage 1
fi

# Ensure server is running (using shared library)
mlx_audio_server_ensure || exit 1

# Prepare temp wav file
TEMP_WAV=$(mktemp /tmp/tts_XXXXXX.wav)
trap 'mlx_audio_cleanup "$TEMP_WAV"' EXIT

# Send request to server
echo "Generating speech..." >&2
if ! curl -s -f -X POST "http://localhost:${MLX_AUDIO_PORT}/v1/audio/speech" \
  -H "Content-Type: application/json" \
  -d "$(jq -n \
    --arg model "$MODEL" \
    --arg input "$TEXT" \
    --arg voice "$VOICE" \
    --argjson speed "$SPEED" \
    '{model: $model, input: $input, voice: $voice, speed: $speed, response_format: "wav"}')" \
  --output "$TEMP_WAV"; then
    echo "Error: Failed to generate speech from server." >&2
    exit 1
fi

# Convert to MP3
echo "Converting to MP3: $OUTPUT" >&2
ffmpeg -y -loglevel error -i "$TEMP_WAV" -ac 1 -ar 16000 -ab 128k "$OUTPUT"

echo "Done: $OUTPUT"
