#!/usr/bin/env bash

set -eo pipefail

PORT=9876
MODEL="mlx-community/Kokoro-82M-bf16"
VOICE="af_heart"
SPEED=1.0
OUTPUT="speech.mp3"
INPUT_FILE=""
TEXT=""

usage() {
    echo "Usage: $0 [TEXT] [--input FILE] [--output FILE] [--speed SPEED]"
    echo ""
    echo "Arguments:"
    echo "  TEXT            Text to speak (optional if --input or stdin is used)"
    echo "  --input FILE    Read text from FILE"
    echo "  --output FILE   Output MP3 file (default: speech.mp3)"
    echo "  --speed SPEED   Speech speed (default: 1.0)"
    exit 1
}

# Parse arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        --input)
            INPUT_FILE="$2"
            shift 2
            ;;
        --output)
            OUTPUT="$2"
            shift 2
            ;;
        --speed)
            SPEED="$2"
            shift 2
            ;;
        -h|--help)
            usage
            ;;
        *)
            if [[ -z "$TEXT" ]]; then
                TEXT="$1"
                shift
            else
                echo "Unknown argument: $1"
                usage
            fi
            ;;
    esac
done

# Resolve input text (Precedence: --input > positional > stdin)
if [[ -n "$INPUT_FILE" ]]; then
    if [[ ! -f "$INPUT_FILE" ]]; then
        echo "Error: Input file '$INPUT_FILE' not found."
        exit 1
    fi
    TEXT=$(cat "$INPUT_FILE")
elif [[ -z "$TEXT" ]]; then
    if [[ ! -t 0 ]]; then
        TEXT=$(cat)
    fi
fi

if [[ -z "$TEXT" ]]; then
    echo "Error: No text provided."
    usage
fi

# Ensure server is running and responsive
check_server() {
    curl -s -f "http://localhost:$PORT/v1/models" > /dev/null 2>&1
}

if ! check_server; then
    # If something is on the port but it's not our server, fail
    if lsof -i :$PORT > /dev/null; then
        echo "Error: Port $PORT is occupied by another process."
        exit 1
    fi

    echo "Starting mlx_audio.server on port $PORT..."
    nohup mlx_audio.server --port $PORT > /tmp/mlx_audio_server.log 2>&1 &
    disown
    
    # Wait for server to be ready
    MAX_RETRIES=30
    COUNT=0
    while ! check_server; do
        sleep 1
        COUNT=$((COUNT + 1))
        if [[ $COUNT -ge $MAX_RETRIES ]]; then
            echo "Error: mlx_audio.server failed to start on port $PORT."
            [[ -f /tmp/mlx_audio_server.log ]] && tail -n 20 /tmp/mlx_audio_server.log
            exit 1
        fi
    done
    echo "Server is ready."
fi

# Prepare temp wav file
TEMP_WAV=$(mktemp /tmp/tts_XXXXXX.wav)

# Ensure cleanup of temp file on exit
cleanup() {
    rm -f "$TEMP_WAV"
}
trap cleanup EXIT

# Send request to server
echo "Generating speech..."
if ! curl -s -f -X POST "http://localhost:$PORT/v1/audio/speech" \
  -H "Content-Type: application/json" \
  -d "$(jq -n \
    --arg model "$MODEL" \
    --arg input "$TEXT" \
    --arg voice "$VOICE" \
    --argjson speed "$SPEED" \
    '{model: $model, input: $input, voice: $voice, speed: $speed}')" \
  --output "$TEMP_WAV"; then
    echo "Error: Failed to generate speech from server."
    exit 1
fi

# Convert to MP3
# Requirements: mono (-ac 1), 16k (-ar 16000), 128k (-ab 128k)
echo "Converting to MP3: $OUTPUT"
ffmpeg -y -loglevel error -i "$TEMP_WAV" -ac 1 -ar 16000 -ab 128k "$OUTPUT"

echo "Done: $OUTPUT"
