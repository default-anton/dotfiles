#!/usr/bin/env bash
set -euo pipefail

cd -- "$(dirname -- "${BASH_SOURCE[0]}")"
# shellcheck disable=SC1091
source ./gpw-lib.sh

gpw_require

usage() {
  cat <<'EOF'
Usage:
  gpw help

  gpw projects list

  gpw repos list [--limit N]

  gpw global ensure
  gpw project ensure --title TITLE

  gpw project items --title TITLE [--status STATUS] [--drafts|--issues|--all] [--json]

  gpw item view --item ITEM_ID [--json]

  gpw draft create  --title TITLE [--body TEXT] [--project TITLE]
  gpw draft convert --item ITEM_ID --repo OWNER/REPO [--project TITLE] [--to-project TITLE] [--delete-from-project]

  gpw repo create --name NAME [--private|--public] [--with-project|--no-project] [--no-protect]

  gpw task create      --repo OWNER/REPO --title TITLE [--body TEXT] [--project TITLE]
  gpw task view        --repo OWNER/REPO --issue N [--json]
  gpw task comment     --repo OWNER/REPO --issue N --body TEXT
  gpw task set-status  --repo OWNER/REPO --issue N --status STATUS [--project TITLE]

  gpw pr add           --repo OWNER/REPO --pr N [--project TITLE]
  gpw pr view          --repo OWNER/REPO --pr N [--json]
  gpw pr set-status    --repo OWNER/REPO --pr N --status STATUS [--project TITLE]
EOF
}

global_project_title() {
  printf '%s' "Global"
}

cmd=${1:-help}
shift || true

case "$cmd" in
  help|-h|--help)
    usage
    ;;

  projects)
    sub=${1:-}
    shift || true
    case "$sub" in
      list)
        gpw_projects_list_json | jq -r '.[] | [.number, .title, .id] | @tsv'
        ;;
      *) die "unknown projects subcommand: $sub" ;;
    esac
    ;;

  repos)
    sub=${1:-}
    shift || true
    case "$sub" in
      list)
        limit=200
        while [[ $# -gt 0 ]]; do
          case "$1" in
            --limit) limit=$2; shift 2 ;;
            *) die "unknown flag: $1" ;;
          esac
        done
        owner="$(gpw_user_login)"
        gh repo list "$owner" --limit "$limit" --json nameWithOwner,visibility,defaultBranchRef --jq '.[] | [.nameWithOwner,.visibility,(.defaultBranchRef.name // "")] | @tsv'
        ;;
      *) die "unknown repos subcommand: $sub" ;;
    esac
    ;;

  global)
    sub=${1:-}
    shift || true
    case "$sub" in
      ensure)
        [[ $# -eq 0 ]] || die "global ensure: no flags (project title is hard-coded: $(global_project_title))"
        title="$(global_project_title)"
        project_id="$(gpw_project_ensure "$title")"
        gpw_project_status_ensure_defaults "$project_id"
        say "$project_id"
        ;;
      *) die "unknown global subcommand: $sub" ;;
    esac
    ;;

  project)
    sub=${1:-}
    shift || true
    case "$sub" in
      ensure)
        title=""
        while [[ $# -gt 0 ]]; do
          case "$1" in
            --title) title=$2; shift 2 ;;
            *) die "unknown flag: $1" ;;
          esac
        done
        [[ -n "$title" ]] || die "missing --title"
        project_id="$(gpw_project_ensure "$title")"
        gpw_project_status_ensure_defaults "$project_id"
        say "$project_id"
        ;;

      items)
        title=""
        status=""
        mode="all" # drafts|issues|all
        as_json=0

        while [[ $# -gt 0 ]]; do
          case "$1" in
            --title) title=$2; shift 2 ;;
            --status) status=$2; shift 2 ;;
            --drafts) mode="drafts"; shift ;;
            --issues) mode="issues"; shift ;;
            --all) mode="all"; shift ;;
            --json) as_json=1; shift ;;
            *) die "unknown flag: $1" ;;
          esac
        done
        [[ -n "$title" ]] || die "missing --title"

        project_id="$(gpw_project_ensure "$title")"
        items="$(gpw_project_items_list_json "$project_id")"

        if [[ -n "$status" ]]; then
          items="$(jq -c --arg status "$status" '[.[] | select((.fieldValues.nodes // []) | map(select(.field.name=="Status"))[0].name == $status)]' <<<"$items")"
        fi

        case "$mode" in
          drafts) items="$(jq -c '[.[] | select(.content.__typename=="DraftIssue")]' <<<"$items")" ;;
          issues) items="$(jq -c '[.[] | select(.content.__typename=="Issue")]' <<<"$items")" ;;
          all) : ;;
          *) die "bad mode: $mode" ;;
        esac

        if [[ "$as_json" -eq 1 ]]; then
          printf '%s\n' "$items"
          exit 0
        fi

        jq -r '
          .[]
          | . as $i
          | ($i.fieldValues.nodes // [] | map(select(.field.name=="Status"))[0].name // "") as $status
          | if $i.content.__typename=="DraftIssue" then
              ["draft", $status, $i.id, $i.content.title]
            elif $i.content.__typename=="Issue" then
              ["issue", $status, ($i.content.repository.nameWithOwner + "#" + ($i.content.number|tostring)), $i.content.title, $i.content.url]
            elif $i.content.__typename=="PullRequest" then
              ["pr", $status, ($i.content.repository.nameWithOwner + "#" + ($i.content.number|tostring)), $i.content.title, $i.content.url]
            else
              ["?", $status, $i.id]
            end
          | @tsv
        ' <<<"$items"
        ;;

      *) die "unknown project subcommand: $sub" ;;
    esac
    ;;

  item)
    sub=${1:-}
    shift || true

    case "$sub" in
      view)
        item_id=""
        as_json=0

        while [[ $# -gt 0 ]]; do
          case "$1" in
            --item) item_id=$2; shift 2 ;;
            --json) as_json=1; shift ;;
            *) die "unknown flag: $1" ;;
          esac
        done
        [[ -n "$item_id" ]] || die "missing --item"

        item_json="$(gpw_project_item_node_json "$item_id")"
        [[ "$item_json" != "null" ]] || die "item not found: $item_id"

        if [[ "$as_json" -eq 1 ]]; then
          printf '%s\n' "$item_json"
          exit 0
        fi

        typename="$(jq -r '.content.__typename // ""' <<<"$item_json")"
        case "$typename" in
          DraftIssue)
            jq -r '"# " + .content.title + "\n\n" + (.content.body // "")' <<<"$item_json"
            ;;
          Issue|PullRequest)
            jq -r '
              (.content.repository.nameWithOwner + "#" + (.content.number|tostring)) + " " + .content.title + "\n" + (.content.url // "") + "\n\n" + (.content.body // "")
            ' <<<"$item_json"
            ;;
          *)
            jq -r '.id' <<<"$item_json"
            ;;
        esac
        ;;

      *) die "unknown item subcommand: $sub" ;;
    esac
    ;;

  draft|idea)
    sub=${1:-}
    shift || true
    case "$sub" in
      create)
        title=""
        body=""
        project_title="$(global_project_title)"

        while [[ $# -gt 0 ]]; do
          case "$1" in
            --title) title=$2; shift 2 ;;
            --body) body=$2; shift 2 ;;
            --project) project_title=$2; shift 2 ;;
            *) die "unknown flag: $1" ;;
          esac
        done
        [[ -n "$title" ]] || die "missing --title"

        project_id="$(gpw_project_ensure "$project_title")"
        gpw_project_status_ensure_defaults "$project_id"

        full_body="$(gpw_body_with_template "$body")"
        item_id="$(gpw_project_item_create_draft "$project_id" "$title" "$full_body")"
        gpw_project_item_set_status "$project_id" "$item_id" "Todo"
        say "$item_id"
        ;;

      convert)
        item_id=""
        repo=""
        project_title="$(global_project_title)"
        to_project=""
        delete_from=0

        while [[ $# -gt 0 ]]; do
          case "$1" in
            --item) item_id=$2; shift 2 ;;
            --repo) repo=$2; shift 2 ;;
            --project) project_title=$2; shift 2 ;;
            --to-project) to_project=$2; shift 2 ;;
            --delete-from-project) delete_from=1; shift ;;
            *) die "unknown flag: $1" ;;
          esac
        done
        [[ -n "$item_id" ]] || die "missing --item"
        [[ -n "$repo" ]] || die "missing --repo"

        project_id="$(gpw_project_ensure "$project_title")"
        repo_id="$(gpw_repo_id "$repo")"

        item_json="$(gpw_project_item_convert_draft_to_issue_json "$item_id" "$repo_id")"
        issue_repo="$(jq -r '.content.repository.nameWithOwner' <<<"$item_json")"
        issue_number="$(jq -r '.content.number' <<<"$item_json")"
        issue_url="$(jq -r '.content.url' <<<"$item_json")"

        if [[ -n "$to_project" ]]; then
          to_project_id="$(gpw_project_ensure "$to_project")"
          gpw_project_status_ensure_defaults "$to_project_id"
          new_item_id="$(gpw_project_item_ensure_issue "$to_project_id" "$issue_repo" "$issue_number")"
          gpw_project_item_set_status "$to_project_id" "$new_item_id" "Todo"

          if [[ "$delete_from" -eq 1 ]]; then
            gpw_project_item_delete "$project_id" "$item_id"
          fi
        fi

        say "$issue_url"
        ;;

      *) die "unknown draft subcommand: $sub" ;;
    esac
    ;;

  repo)
    sub=${1:-}
    shift || true
    case "$sub" in
      create)
        name=""
        visibility="--private"
        with_project=1
        protect=1

        while [[ $# -gt 0 ]]; do
          case "$1" in
            --name) name=$2; shift 2 ;;
            --private) visibility="--private"; shift ;;
            --public) visibility="--public"; shift ;;
            --with-project) with_project=1; shift ;;
            --no-project) with_project=0; shift ;;
            --no-protect) protect=0; shift ;;
            *) die "unknown flag: $1" ;;
          esac
        done
        [[ -n "$name" ]] || die "missing --name"

        owner="$(gpw_user_login)"
        repo="$owner/$name"

        gh repo create "$repo" "$visibility" --add-readme >/dev/null
        if [[ "$protect" -eq 1 ]]; then
          gpw_repo_default_branch_protect "$repo"
        fi

        if [[ "$with_project" -eq 1 ]]; then
          project_id="$(gpw_project_ensure "$name")"
          gpw_project_status_ensure_defaults "$project_id"
          say "$repo $project_id"
        else
          say "$repo"
        fi
        ;;
      *) die "unknown repo subcommand: $sub" ;;
    esac
    ;;

  task)
    sub=${1:-}
    shift || true

    case "$sub" in
      create)
        repo=""
        title=""
        body=""
        project_title=""

        while [[ $# -gt 0 ]]; do
          case "$1" in
            --repo) repo=$2; shift 2 ;;
            --title) title=$2; shift 2 ;;
            --body) body=$2; shift 2 ;;
            --project) project_title=$2; shift 2 ;;
            *) die "unknown flag: $1" ;;
          esac
        done
        [[ -n "$repo" ]] || die "missing --repo"
        [[ -n "$title" ]] || die "missing --title"

        if [[ -z "$project_title" ]]; then
          project_title="$(gpw_repo_default_project_title "$repo")"
        fi

        project_id="$(gpw_project_ensure "$project_title")"
        gpw_project_status_ensure_defaults "$project_id"

        full_body="$(gpw_body_with_template "$body")"
        url="$(gh issue create -R "$repo" -t "$title" -b "$full_body")"
        issue_number="$(gh issue view "$url" -R "$repo" --json number --jq .number)"

        item_id="$(gpw_project_item_ensure_issue "$project_id" "$repo" "$issue_number")"
        gpw_project_item_set_status "$project_id" "$item_id" "Todo"

        say "$url"
        ;;

      view)
        repo=""
        issue=""
        as_json=0

        while [[ $# -gt 0 ]]; do
          case "$1" in
            --repo) repo=$2; shift 2 ;;
            --issue) issue=$2; shift 2 ;;
            --json) as_json=1; shift ;;
            *) die "unknown flag: $1" ;;
          esac
        done
        [[ -n "$repo" ]] || die "missing --repo"
        [[ -n "$issue" ]] || die "missing --issue"

        if [[ "$as_json" -eq 1 ]]; then
          gh issue view "$issue" -R "$repo" --json number,title,url,body,state,author,assignees,labels
          exit 0
        fi

        gh issue view "$issue" -R "$repo" --json number,title,url,body --jq '(.number|tostring)+" "+.title+"\n"+.url+"\n\n"+.body'
        ;;

      comment)
        repo=""
        issue=""
        body=""

        while [[ $# -gt 0 ]]; do
          case "$1" in
            --repo) repo=$2; shift 2 ;;
            --issue) issue=$2; shift 2 ;;
            --body) body=$2; shift 2 ;;
            *) die "unknown flag: $1" ;;
          esac
        done
        [[ -n "$repo" ]] || die "missing --repo"
        [[ -n "$issue" ]] || die "missing --issue"
        [[ -n "$body" ]] || die "missing --body"

        gh issue comment -R "$repo" "$issue" --body "$body"
        ;;

      set-status)
        repo=""
        issue=""
        project_title=""
        status_name=""

        while [[ $# -gt 0 ]]; do
          case "$1" in
            --repo) repo=$2; shift 2 ;;
            --issue) issue=$2; shift 2 ;;
            --project) project_title=$2; shift 2 ;;
            --status) status_name=$2; shift 2 ;;
            *) die "unknown flag: $1" ;;
          esac
        done
        [[ -n "$repo" ]] || die "missing --repo"
        [[ -n "$issue" ]] || die "missing --issue"

        if [[ -z "$project_title" ]]; then
          project_title="$(gpw_repo_default_project_title "$repo")"
        fi

        [[ -n "$status_name" ]] || die "missing --status"

        project_id="$(gpw_project_ensure "$project_title")"
        gpw_project_status_ensure_defaults "$project_id"

        item_id="$(gpw_project_item_ensure_issue "$project_id" "$repo" "$issue")"
        gpw_project_item_set_status "$project_id" "$item_id" "$status_name"
        say "$item_id"
        ;;

      *) die "unknown task subcommand: $sub" ;;
    esac
    ;;

  pr)
    sub=${1:-}
    shift || true

    case "$sub" in
      add)
        repo=""
        pr=""
        project_title=""

        while [[ $# -gt 0 ]]; do
          case "$1" in
            --repo) repo=$2; shift 2 ;;
            --pr) pr=$2; shift 2 ;;
            --project) project_title=$2; shift 2 ;;
            *) die "unknown flag: $1" ;;
          esac
        done
        [[ -n "$repo" ]] || die "missing --repo"
        [[ -n "$pr" ]] || die "missing --pr"

        if [[ -z "$project_title" ]]; then
          project_title="$(gpw_repo_default_project_title "$repo")"
        fi

        project_id="$(gpw_project_ensure "$project_title")"
        gpw_project_status_ensure_defaults "$project_id"

        item_id="$(gpw_project_item_ensure_pr "$project_id" "$repo" "$pr")"
        say "$item_id"
        ;;

      view)
        repo=""
        pr=""
        as_json=0

        while [[ $# -gt 0 ]]; do
          case "$1" in
            --repo) repo=$2; shift 2 ;;
            --pr) pr=$2; shift 2 ;;
            --json) as_json=1; shift ;;
            *) die "unknown flag: $1" ;;
          esac
        done
        [[ -n "$repo" ]] || die "missing --repo"
        [[ -n "$pr" ]] || die "missing --pr"

        if [[ "$as_json" -eq 1 ]]; then
          gh pr view "$pr" -R "$repo" --json number,title,url,body,state,author,assignees,labels
          exit 0
        fi

        gh pr view "$pr" -R "$repo" --json number,title,url,body --jq '(.number|tostring)+" "+.title+"\n"+.url+"\n\n"+.body'
        ;;

      set-status)
        repo=""
        pr=""
        project_title=""
        status_name=""

        while [[ $# -gt 0 ]]; do
          case "$1" in
            --repo) repo=$2; shift 2 ;;
            --pr) pr=$2; shift 2 ;;
            --project) project_title=$2; shift 2 ;;
            --status) status_name=$2; shift 2 ;;
            *) die "unknown flag: $1" ;;
          esac
        done
        [[ -n "$repo" ]] || die "missing --repo"
        [[ -n "$pr" ]] || die "missing --pr"

        if [[ -z "$project_title" ]]; then
          project_title="$(gpw_repo_default_project_title "$repo")"
        fi

        [[ -n "$status_name" ]] || die "missing --status"
        if [[ "$status_name" == "In Progress" ]]; then
          die "status In Progress only valid for issues"
        fi

        project_id="$(gpw_project_ensure "$project_title")"
        gpw_project_status_ensure_defaults "$project_id"

        item_id="$(gpw_project_item_ensure_pr "$project_id" "$repo" "$pr")"
        gpw_project_item_set_status "$project_id" "$item_id" "$status_name"
        say "$item_id"
        ;;

      *) die "unknown pr subcommand: $sub" ;;
    esac
    ;;

  *)
    usage
    die "unknown command: $cmd"
    ;;
esac
